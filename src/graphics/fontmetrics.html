<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">

<link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Roboto+Mono' rel='stylesheet' type='text/css'>

<script type="text/javascript">
function doit()
{
  // measureText returns pixles, but we store metrics in points
  var pxToPoints = 0.75;

  // hack for ascent/descent since its not supported by TextMetrics yet
  var heights = {
    "Helvetica":   "770/230",
    "Roboto":      "967/211",
    "Times":       "750/250",
    "Courier":     "754/247",
    "Roboto Mono": "967/211",
  };

  // list of fonts to generate metrics for
  var fonts = [
    "normal 400 Helvetica",
    "normal 700 Helvetica",
    "italic 400 Helvetica",
    "italic 700 Helvetica",

    "normal 300 Roboto",
    "normal 400 Roboto",
    "normal 500 Roboto",
    "normal 700 Roboto",

    "normal 400 Times",
    "normal 700 Times",
    "italic 400 Times",
    "italic 700 Times",

    "normal 400 Courier",
    "normal 700 Courier",
    "italic 400 Courier",
    "italic 700 Courier",

    "normal 400 Roboto-Mono",
    ];

  // create canvas
  var canvas = document.getElementById("canvas");
  var g = canvas.getContext("2d");
  g.fillStyle = "#000";
  g.strokeStyle = "#f00";

  // iterate fonts
  var x = 10;
  var y = 40;
  var yincr = 30;
  var indent = "      ";
  var output = indent + "// Auto-generated by fontmetrics.html [" + Date() + "]\n";
  for (var i = 0; i < fonts.length; ++i)
  {
    var spec    = fonts[i]
    var toks    = spec.split(" ");
    var style   = toks[0];
    var weight  = toks[1];
    var name    = toks[2].replace("-", " ");
    var ascent  = heights[name].split("/")[0];
    var descent = heights[name].split("/")[1];

    // paint 16pt font to canvas
    g.font = style + " " + weight + " 16pt " + name;
    console.log("Generating " + spec + " | " + g.font);
    var str = "The quick brown fox jumps over the lazy dog (" + spec + ")";
    var tw = g.measureText(str).width;
    g.fillText(str, x, y);
    g.beginPath(); g.moveTo(x, y); g.lineTo(x+tw, y); g.stroke();
    y += yincr;

    // use 1000pt font to calculate widths and char map
    g.font = style + " " + weight + " 1000pt " + name;
    var widthsMap = {};
    var chars  = [];
    for (var ch = 0x20; ch <= 0xff; ++ch)
    {
      var cw = g.measureText(String.fromCharCode(ch)).width;
      var cw = Math.round(cw * pxToPoints);
      widthsMap[cw.toString()] = cw;
      chars.push(cw);
    }

    // sort widths
    var widthsAll = Object.values(widthsMap).sort(function comparator(a, b) { return a - b; });

    // trim down the widths for ones that are really close together
    // and create map of widths to index into widths array
    var widths = [];
    var widthsToIndex = {};
    for (var j=0; j<widthsAll.length; ++j)
    {
      if (j+1 < widthsAll.length && widthsAll[j+1] - widthsAll[j] < 4)
      {
        widthsToIndex[widthsAll[j].toString()] = widths.length;
        j++;
      }
      widthsToIndex[widthsAll[j].toString()] = widths.length;
      widths.push(widthsAll[j]);
    }

    // use string to index (char - 32) to index in widths table with the
    // ASCII char '%' 37 + index (avoids dollar and double quote)
    var charsMap = "";
    for (var j=0; j<chars.length; ++j)
    {
      var widthIndex = widthsToIndex[chars[j].toString()];
      var ch = 37 + widthIndex;
      if (ch > 128) throw "Bad mapping: " + ch;
      var ch = String.fromCharCode(ch);
      if (ch == "\\") ch = "\\\\";
      charsMap = charsMap.concat(ch);
    }

    var line = indent + 'register(acc, make("' + spec + '",' + ascent + ',' + descent + ',[' + widths + '],"' + charsMap + '"))\n'
    output += line
  }

  // update output pre element
  output += "\n\n\n"
  document.getElementById("output").appendChild( document.createTextNode(output));
}
</script>

<title>Font Metrics Generation</title>
</head>
<body onload='doit()'>

<div>
<canvas id='canvas' width='1000' height='600'/>
</div>

<div>
<hr/>
<p style='font: 14pt Helvetica'>The quick brown fox jumps over the lazy dog (Helvetica)</p>
<p style='font: 14pt Roboto'>The quick brown fox jumps over the lazy dog (Roboto)</p>
<p style='font: 300 14pt Roboto'>The quick brown fox jumps over the lazy dog (300 Roboto)</p>
<p style='font: 500 14pt Roboto'>The quick brown fox jumps over the lazy dog (500 Roboto)</p>
<p style='font: 700 14pt Roboto'>The quick brown fox jumps over the lazy dog (700 Roboto)</p>
<p style='font: 14pt Times'>The quick brown fox jumps over the lazy dog (Times)</p>
<p style='font: 14pt Courier'>The quick brown fox jumps over the lazy dog (Courier)</p>
<p style='font: 14pt "Roboto Mono"'>Roboto Mono (Roboto Mono)</p>
</div>

<div>
<hr/>
<pre id='output'>
</pre>
</div>

</body>
</html>